<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Decolonial piano</title>
    <meta
      name="description"
      content="Who says there has to be 12 semitones in an octave?"
    />

    <link rel="stylesheet" type="text/css" href="/sheep3.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <script src="/sheep3.js" charset="utf-8"></script>

    <style>
      @media (prefers-color-scheme: dark) {
        :root {
          color-scheme: dark;
        }
      }
      html,
      body,
      #root {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: 'Montserrat', sans-serif;
      }

      #root {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 20px;
      }

      button {
        border: none;
        background: none;
        color: inherit;
        font: inherit;
      }
      button:not(:disabled) {
        cursor: pointer;
      }

      svg {
        fill: none;
        stroke: currentColor;
        stroke-width: 2px;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .key-counts,
      .waveforms {
        display: flex;
        gap: 10px;
        padding: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin: 0 auto;
      }
      .key-count,
      .waveform {
        height: 30px;
        cursor: pointer;
        position: relative;
        border: 1px solid color-mix(in srgb, CanvasText 10%, transparent);
        border-radius: 5px;
        transition: background-color 0.2s;
        &:not(.selected):hover {
          background-color: color-mix(in srgb, CanvasText 5%, transparent);
        }
        &:has(> :focus-visible) {
          box-shadow: 0 0 0 1px Canvas, 0 0 0 3px LinkText;
        }

        & input {
          opacity: 0;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
          cursor: pointer;
        }
      }
      .key-count {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        font-weight: bold;
      }
      .waveform {
        font-size: 0;
        padding: 5px;
        box-sizing: border-box;
        & svg {
          height: 100%;
        }
      }
      .selected {
        background-color: CanvasText;
        color: Canvas;
      }
      .sound-btn {
        font-size: 0;
        width: 30px;
        height: 30px;
        padding: 0;
      }
      .alert {
        color: Canvas;
        background-color: CanvasText;
        border-radius: 50%;
        box-shadow: 0 0 0 3px Canvas, 0 0 0 5px CanvasText;
      }

      .piano-wrapper {
        width: 100%;
        overflow: hidden;
        display: flex;
        justify-content: center;
      }
      .piano {
        display: flex;
        height: 400px;
        border: 1px solid color-mix(in srgb, CanvasText 10%, transparent);
        border-right: none;
        user-select: none;
        --semitones: 12;
      }
      .key {
        width: 80px;
        max-width: calc(100vw / calc(var(--semitones) + 2));
        border-right: 1px solid color-mix(in srgb, CanvasText 10%, transparent);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-end;
        box-sizing: border-box;
        cursor: pointer;
        touch-action: none;
        container-type: inline-size;

        & kbd {
          font: inherit;
          padding: 0 5px;
          border: 2px solid color-mix(in srgb, currentColor 10%, transparent);
          border-bottom-width: 4px;
          border-radius: 5px;
          font-size: 0.8em;
          color: color-mix(in srgb, currentColor 80%, transparent);
          margin: 10px;
        }
      }
      @container (max-width: 45px) {
        .key kbd {
          margin: 10px auto;
        }
        .key .key-name {
          margin: 0 auto;
          font-size: 0.5em;
        }
      }
      @container (max-width: 30px) {
        .key kbd {
          display: none;
        }
        .key .key-name {
          margin: 10px auto;
        }
      }
      .hidden {
        visibility: hidden;
      }
      .current-octave {
        background-color: color-mix(in srgb, CanvasText 2%, transparent);
      }
      .key-name {
        color: color-mix(in srgb, currentColor 50%, transparent);
        font-size: 0.8em;
        margin: 0 10px;
      }
      .has-approx {
        color: color-mix(in srgb, currentColor 20%, transparent);
      }
      .approx {
        font-size: 0.8em;
      }
      .pressed {
        background-color: CanvasText;
        color: Canvas;
      }

      .base-note-wrapper {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 0 20px;

        & input {
          flex: auto;
          touch-action: none;
        }
      }
      .base-note {
        width: 150px;
        display: flex;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      import { h, render, Fragment } from 'https://esm.sh/preact@10.28.0'
      import {
        useState,
        useEffect,
        useRef
      } from 'https://esm.sh/preact@10.28.0/hooks'

      const KEYS = [...'`1234567890-=', 'Backspace']
      const NOTE_NAMES = [
        'A',
        'A#',
        'B',
        'C',
        'C#',
        'D',
        'D#',
        'E',
        'F',
        'F#',
        'G',
        'G#'
      ]
      const DEFAULT_SEMITONES = NOTE_NAMES.length

      const WH = 10
      const WAVEFORMS = {
        // Gemini
        sine: `M 0 ${
          WH / 2
        } q 5 ${-WH} 10 0 t 10 0 t 10 0 t 10 0 t 10 0 t 10 0`,
        // ChatGPT
        // sine: `M 0 ${
        //   WH / 2
        // } c 10 0 10 ${-WH} 20 ${-WH} c 10 0 10 ${WH} 20 ${WH} c 10 0 10 ${-WH} 20 ${-WH} c 10 0 10 ${WH} 20 ${WH}`,
        triangle: `M 0 ${WH / 2} l 5 ${
          WH / 2
        } l 10 ${-WH} l 10 ${WH} l 10 ${-WH} l 10 ${WH} l 10 ${-WH} l 5 ${
          WH / 2
        }`,
        sawtooth: `M 0 ${WH} l 20 ${-WH} v ${WH} l 20 ${-WH} v ${WH} l 20 ${-WH} v ${WH}`,
        square: `M 0 ${WH} v ${-WH} h 10 v ${WH} h 10 v ${-WH} h 10 v ${WH} h 10 v ${-WH} h 10 v ${WH} h 10 v ${-WH}`
      }

      const audioContext = new AudioContext()

      function noteFromFreq (freq) {
        const semitones = Math.log2(freq / 440) * DEFAULT_SEMITONES
        const closest = Math.round(semitones)
        const octave = Math.floor(closest / DEFAULT_SEMITONES)
        const note =
          ((closest % DEFAULT_SEMITONES) + DEFAULT_SEMITONES) %
          DEFAULT_SEMITONES
        return {
          displayName: NOTE_NAMES[note] + octave,
          // Up to 0.5
          error: Math.abs(closest - semitones)
        }
      }

      function App () {
        const [semitones, setSemitones] = useState(DEFAULT_SEMITONES)
        const [pressed, setPressed] = useState(new Set())
        const [mousePressed, setMousePressed] = useState(false)
        const [muted, setMuted] = useState(true)
        const [base, setBase] = useState(4 * DEFAULT_SEMITONES) // A4
        const [waveform, setWaveform] = useState('sine')

        const baseNote = base % DEFAULT_SEMITONES
        const baseOctave = Math.floor(base / DEFAULT_SEMITONES)
        const baseFreq = 440 * 2 ** (base / DEFAULT_SEMITONES - 4)
        const extraOctaves = semitones > 5 ? 1 : semitones > 3 ? 2 : 3
        const keyOffset = Math.floor((KEYS.length - semitones) / 2)

        useEffect(() => {
          const handleKeyDown = e => {
            if (KEYS.includes(e.key)) {
              setPressed(pressed => pressed.union(new Set([e.key])))
            }
            if (audioContext.state !== 'running') {
              audioContext.resume()
            }
          }
          const handleKeyUp = e => {
            setPressed(pressed => pressed.difference(new Set([e.key])))
          }
          const handlePointerDown = e => {
            if (e.pointerType !== 'touch') {
              setMousePressed(true)
            }
            if (audioContext.state !== 'running') {
              audioContext.resume()
            }
          }
          const handlePointerEnd = e => {
            if (e.pointerType !== 'touch') {
              setMousePressed(false)
              setPressed(
                pressed =>
                  new Set(
                    Array.from(pressed).filter(key => typeof key === 'string')
                  )
              )
            }
          }

          window.addEventListener('keydown', handleKeyDown)
          window.addEventListener('keyup', handleKeyUp)
          window.addEventListener('pointerdown', handlePointerDown)
          window.addEventListener('pointerup', handlePointerEnd)
          window.addEventListener('pointercancel', handlePointerEnd)

          return () => {
            window.removeEventListener('keydown', handleKeyDown)
            window.removeEventListener('keyup', handleKeyUp)
            window.removeEventListener('pointerdown', handlePointerDown)
            window.removeEventListener('pointerup', handlePointerEnd)
            window.removeEventListener('pointercancel', handlePointerEnd)
          }
        }, [])

        useEffect(() => {
          setMuted(audioContext.state !== 'running')
        }, [muted])

        const audioNodes = useRef()

        useEffect(() => {
          const nodes = Array.from(
            { length: (2 * extraOctaves + 1) * semitones + 1 },
            (_, i) => {
              const index = i - extraOctaves * semitones

              const oscillatorNode = audioContext.createOscillator()
              oscillatorNode.frequency.value =
                baseFreq * 2 ** (index / semitones)
              oscillatorNode.type = waveform
              oscillatorNode.start()

              const gainNode = audioContext.createGain()
              gainNode.gain.value = 0

              oscillatorNode.connect(gainNode)
              gainNode.connect(audioContext.destination)

              return { oscillatorNode, gainNode }
            }
          )
          audioNodes.current = nodes.map(({ gainNode }) => gainNode)
          return () => {
            for (const { oscillatorNode, gainNode } of nodes) {
              oscillatorNode.stop()
              gainNode.disconnect()
            }
          }
        }, [baseFreq, semitones, extraOctaves, waveform])

        useEffect(() => {
          setMuted(audioContext.state !== 'running')
          for (const [i, gainNode] of audioNodes.current.entries()) {
            const index = i - extraOctaves * semitones
            const keyIndex = index + keyOffset
            const isPressed =
              (keyIndex >= 0 &&
                keyIndex < KEYS.length &&
                pressed.has(KEYS[keyIndex])) ||
              pressed.has(index)
            gainNode.gain.value = isPressed ? 1 : 0
          }
        }, [pressed])

        return h(
          Fragment,
          null,
          h(
            'div',
            { class: 'waveforms' },
            h(
              'button',
              {
                type: 'button',
                class: `sound-btn ${muted && pressed.size > 0 ? 'alert' : ''}`,
                onClick: async () => {
                  try {
                    if (audioContext.state === 'running') {
                      await audioContext.suspend()
                    } else {
                      await audioContext.resume()
                    }
                  } finally {
                    setMuted(audioContext.state !== 'running')
                  }
                }
              },
              // https://github.com/feathericons/feather/blob/main/icons/volume-2.svg
              h(
                'svg',
                {
                  'aria-hidden': true,
                  xmlns: 'http://www.w3.org/2000/svg',
                  width: '24',
                  height: '24',
                  viewBox: '0 0 24 24'
                },
                h('path', {
                  d: `M 11 5 L 6 9 L 2 9 L 2 15 L 6 15 L 11 19 L 11 5 z ${
                    muted
                      ? 'M 23 9 17 15 M 17 9 23 15'
                      : 'M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07'
                  }`
                })
              ),
              muted ? 'Enable sound' : 'Mute'
            ),
            Object.entries(WAVEFORMS).map(([waveformName, path]) =>
              h(
                'label',
                {
                  key: waveformName,
                  class: `waveform ${
                    waveform === waveformName ? 'selected' : ''
                  }`
                },
                h('input', {
                  type: 'radio',
                  name: 'waveform',
                  value: waveformName,
                  checked: waveform === waveformName,
                  onClick: () => setWaveform(waveformName)
                }),
                waveformName,
                h(
                  'svg',
                  {
                    'aria-hidden': true,
                    xmlns: 'http://www.w3.org/2000/svg',
                    viewBox: `-2 -2 64 ${WH + 4}`
                  },
                  h('path', { d: path })
                )
              )
            )
          ),
          h(
            'div',
            { class: 'key-counts' },
            Array.from({ length: 16 }, (_, i) =>
              h(
                'label',
                {
                  key: i,
                  class: `key-count ${semitones === i + 1 ? 'selected' : ''}`
                },
                h('input', {
                  type: 'radio',
                  name: 'semitones',
                  value: i + 1,
                  checked: semitones === i + 1,
                  onClick: () => setSemitones(i + 1)
                }),
                i + 1
              )
            )
          ),
          h(
            'div',
            { class: 'piano-wrapper' },
            h(
              'div',
              {
                class: 'piano',
                // Prevent touch long press right click on Windows
                onContextMenu: e => e.preventDefault(),
                style: {
                  '--semitones': semitones
                }
              },
              Array.from({ length: 2 * extraOctaves + 2 }, (_, i) =>
                h(
                  Fragment,
                  { key: i - extraOctaves },
                  Array.from(
                    { length: i === 2 * extraOctaves + 1 ? 1 : semitones },
                    (_, j) => {
                      const index = (i - extraOctaves) * semitones + j
                      const semitone = index / semitones

                      const keyIndex = index + keyOffset
                      const key =
                        keyIndex >= 0 && keyIndex < KEYS.length
                          ? KEYS[keyIndex]
                          : null

                      const freq = baseFreq * 2 ** (index / semitones)
                      const approxNote = noteFromFreq(freq)

                      const pointerEnd = e => {
                        if (e.currentTarget.hasPointerCapture(e.pointerId)) {
                          setPressed(pressed =>
                            pressed.difference(new Set([index]))
                          )
                        }
                      }

                      return h(
                        'div',
                        {
                          class: `key ${
                            index >= 0 && index <= semitones
                              ? 'current-octave'
                              : ''
                          } ${
                            pressed.has(key) || pressed.has(index)
                              ? 'pressed'
                              : ''
                          }`,
                          onPointerDown: e => {
                            setPressed(pressed =>
                              pressed.union(new Set([index]))
                            )
                            if (e.pointerType === 'touch') {
                              e.currentTarget.setPointerCapture(e.pointerId)
                            }
                          },
                          onPointerUp: pointerEnd,
                          onPointerCancel: pointerEnd,
                          onPointerEnter: e => {
                            if (e.pointerType !== 'touch' && mousePressed) {
                              setPressed(pressed =>
                                pressed.union(new Set([index]))
                              )
                            }
                          },
                          onPointerLeave: e => {
                            if (e.pointerType !== 'touch') {
                              setPressed(pressed =>
                                pressed.difference(new Set([index]))
                              )
                            }
                          }
                        },
                        semitones === DEFAULT_SEMITONES || j === 0
                          ? h(
                            'div',
                            { class: 'key-name' },
                            NOTE_NAMES[(j + baseNote) % DEFAULT_SEMITONES] +
                              (i - extraOctaves + baseOctave)
                          )
                          : h(
                            'div',
                            {
                              class: `key-name ${
                                approxNote.error > 0.01 ? 'has-approx' : ''
                              }`
                            },
                            approxNote.error > 0.01
                              ? h(
                                'div',
                                { class: 'approx' },
                                `${((1 - approxNote.error) * 100).toFixed(0)}%`
                              )
                              : null,
                            approxNote.displayName
                          ),
                        key
                          ? h(
                            'kbd',
                            { class: 'key-key' },
                            key === 'Backspace' ? 'â†' : key
                          )
                          : h('kbd', { class: 'key-key hidden' }, '.')
                      )
                    }
                  )
                )
              )
            )
          ),
          h(
            'label',
            { class: 'base-note-wrapper' },
            h('input', {
              type: 'range',
              min: 3 * DEFAULT_SEMITONES,
              max: 6 * DEFAULT_SEMITONES,
              value: base,
              onInput: e => setBase(e.currentTarget.valueAsNumber)
            }),
            h(
              'span',
              { class: 'base-note' },
              h(
                'span',
                null,
                NOTE_NAMES[base % DEFAULT_SEMITONES],
                Math.floor(base / DEFAULT_SEMITONES)
              ),
              h('span', null, ` (${+baseFreq.toFixed(3)} Hz)`)
            )
          )
        )
      }

      render(h(App), document.getElementById('root'))
    </script>
  </body>
</html>
