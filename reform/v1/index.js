var C=0,x,v;function S(e){if(!v||!x){x=Object.assign(document.createElement("a"),{className:"error-count",href:"#errors"});let o=Object.assign(document.createElement("h2"),{className:"error-count-wrapper"});o.append(x);let t=Object.assign(document.createElement("p"),{className:"error-note",textContent:"It could be due to a bug, or your input is not the correct format. If you'd like to report the error, please send me the entire error log below."});v=Object.assign(document.createElement("pre"),{className:"error-log"});let r=Object.assign(document.createElement("div"),{className:"error-wrapper",id:"errors"});r.append(t,v),document.body.append(o,r)}v.append(e,`
`),C++,x.textContent=`${C} error${C===1?"":"s"} occurred`}window.onerror=(e,o,t,r,n)=>{S(n?.stack&&n.stack.includes(n.name)?`Uncaught ${n.stack}`:`Uncaught ${n?.name??String(n)}: ${e} at ${o}:${t}${r!==void 0?":"+r:""}${n?.stack?`
`+n.stack.replaceAll(`
`,`
	`):""}`)};window.addEventListener("unhandledrejection",({reason:e})=>{S(e?.stack&&e.stack.includes(e.name)?`Uncaught (in promise) ${e.stack}`:e instanceof Error?`Uncaught (in promise) ${e.constructor.name}: ${e.message}${e?.stack?`
`+e.stack.replaceAll(`
`,`
	`):""}`:String(e))});function m(e){return e>1e9?`${(e/1e9).toPrecision(3)} GB`:e>1e6?`${(e/1e6).toPrecision(3)} MB`:e>1e3?`${(e/1e3).toPrecision(3)} kB`:e!==1?`${e} bytes`:"1 byte"}function T(e){let o=e.lastIndexOf(".");return o===-1?e:e.slice(0,o)}var D=new TextEncoder;function L(e,o){return e.find(({type:t})=>o.some(r=>t.startsWith(r)))??e[0]}function V(e){return e.kind==="string"?new Promise(o=>e.getAsString(o)):Promise.resolve(e.getAsFile())}function y({fileName:e,input:o,dropTarget:t,pasteTarget:r,pasteButton:n,defaultPreferredTypes:l,onFile:s}){let p=o.accept?o.accept.replaceAll("*","").split(","):l;async function g(a){let i;switch(a.type){case"files":{i=L(Array.from(a.files),p);break}case"data-transfer":{i=await V(L(Array.from(a.transfer.items),p));break}case"clipboard":{let{item:b,type:I}=L(a.items,p),j=await b.getType(I);i=new File([j],I.replaceAll("/","_"),{type:j.type});break}}if(i===null)return;let c=i instanceof File?`${i.name} \xB7 ${m(i.size)}`:`Plain text \xB7 ${m(D.encode(i).length)}`;try{(await s(i)??!0)&&e&&(e.textContent=c,e.classList.remove("file-error"))}catch(b){throw e&&(e.textContent=c+" \u2014 failed to load",e.classList.add("file-error")),b}}if(o.addEventListener("change",()=>{o.files&&o.files.length>0&&g({type:"files",files:o.files}),o.value=""}),o.dataset.default){let a=o.dataset.default,i=a.slice(a.lastIndexOf("/")+1);fetch(a).then(c=>c.blob()).catch(c=>{throw e&&(e.textContent=i+" \u2014 failed to load",e.classList.add("file-error")),c}).then(c=>g({type:"files",files:[new File([c],i,c)]}))}t?.addEventListener("drop",a=>{a.dataTransfer&&a.dataTransfer.items.length>0&&g({type:"data-transfer",transfer:a.dataTransfer}),t.classList.remove("drag-over"),a.preventDefault()}),t?.addEventListener("dragover",a=>{t.classList.add("drag-over"),a.preventDefault()}),t?.addEventListener("dragleave",()=>{t.classList.remove("drag-over")}),r&&document.addEventListener("paste",a=>{(a.target instanceof HTMLTextAreaElement||a.target instanceof HTMLInputElement)&&!a.target.readOnly&&!a.target.disabled||a.clipboardData&&a.clipboardData.items.length>0&&g({type:"data-transfer",transfer:a.clipboardData})});let u=null;n?.addEventListener("click",async()=>{try{n.disabled=!0;let i=(await navigator.clipboard.read()).flatMap(c=>c.types.map(b=>({item:c,type:b})));i.length>0&&g({type:"clipboard",items:i}),u&&clearTimeout(u),n.classList.add("icon-done"),u=setTimeout(()=>{n.classList.remove("icon-done")},1e3)}catch(a){if(a instanceof DOMException&&a.name==="NotAllowedError")console.warn("Failed to read clipboard",a);else throw a}finally{n.disabled=!1}})}function O(e,o){o.dataset.ignore="true";let t=o.closest(".reform\\:io"),r=k(t);y({fileName:o.parentElement?.querySelector(".file-name")??null,input:o,dropTarget:t instanceof HTMLElement?t:null,pasteTarget:o.classList.contains("reform:paste-target"),pasteButton:r,defaultPreferredTypes:[],onFile:async n=>{e.handleValue(n instanceof File?n:new File([n],"text.txt",{type:"text/plain"}))}})}function F(e,o){o.dataset.ignore="true";let t=o.closest(".reform\\:io"),r=k(t),n=t?.querySelector(".input-content canvas");n&&!(n instanceof HTMLCanvasElement)&&(console.warn(n,"is not a <canvas> element"),n=null);let l=n??document.createElement("canvas"),s=l.getContext("2d",{willReadFrequently:!!l.dataset.willReadFrequently});if(!s)throw new TypeError("Failed to get canvas context for the image input preview.");y({fileName:o.parentElement?.querySelector(".file-name")??null,input:o,dropTarget:t instanceof HTMLElement?t:null,pasteTarget:o.classList.contains("reform:paste-target")??!1,pasteButton:r,defaultPreferredTypes:["image/*"],onFile:async p=>{if(typeof p=="string")return!1;let g=URL.createObjectURL(p);try{let u=document.createElement("img");u.src=g,await new Promise((a,i)=>{u.addEventListener("load",a),u.addEventListener("error",()=>i(new TypeError(`Could not load '${p.name}' as image.`)))}),l.dataset.name=T(p.name),l.width=u.width,l.height=u.height,s.drawImage(u,0,0),e.handleValue(s)}finally{URL.revokeObjectURL(g)}}})}function R(e,o){o.dataset.ignore="true";let t=o.closest(".reform\\:io"),r=k(t),n=t?.querySelector(".input-content video");n&&!(n instanceof HTMLVideoElement)&&(console.warn(n,"is not a <video> element"),n=null);let l=n??document.createElement("video"),s;y({fileName:o.parentElement?.querySelector(".file-name")??null,input:o,dropTarget:t instanceof HTMLElement?t:null,pasteTarget:o.classList.contains("reform:paste-target"),pasteButton:r,defaultPreferredTypes:["video/*"],onFile:async p=>{if(typeof p=="string")return!1;s&&URL.revokeObjectURL(s),s=URL.createObjectURL(p),l.src=s,l.dataset.name=T(p.name),await new Promise((g,u)=>{l.onloadeddata=()=>{l.readyState<2||g()},l.onerror=()=>u(new TypeError(`Could not load '${p.name}' as video.`))}),e.handleValue(l)}})}function N(e,o){let t=o.closest(".reform\\:io"),r=k(t);o.dataset.ignore="true";let n=t?.querySelector(".input-controls"),l=t?.querySelector(".input-content");y({fileName:o.parentElement?.querySelector(".file-name")??null,input:o,dropTarget:n instanceof HTMLElement?n:null,pasteTarget:o.classList.contains("reform:paste-target"),pasteButton:r,defaultPreferredTypes:["text/plain"],onFile:async s=>{let p=s instanceof File?await s.text():s;l instanceof HTMLTextAreaElement&&(l.value=p),e.handleValue(p)}})}function k(e){let o=e?.querySelector(".input-controls");if(o instanceof HTMLLabelElement){let t=document.createElement("div");t.classList.add("input-controls"),o.classList.remove("input-controls"),o.replaceWith(t),t.append(o),o=t}if(o&&!e?.querySelector(".reform\\:paste")){let t=document.createElement("button");return t.type="button",t.classList.add("icon","icon-paste","reform:paste"),t.ariaLabel="Paste from clipboard",t.title="Paste from clipboard",o.append(t),t}return null}var E=class e{#e=null;#o=null;#i=null;#t=null;#l;#r=null;#n=!1;#s=null;#d=null;constructor(o){this.#l=o;let{copyButton:t,shareButton:r}=o;t&&(t.disabled=!0),r&&(r.disabled=!0),t?.addEventListener("click",async()=>{try{t.disabled=!0,this.#i??=this.#a(!0);let n=await this.#i;if(!n)return;await navigator.clipboard.write([new ClipboardItem({[n.type]:n})]),this.#s&&clearTimeout(this.#s),t.classList.add("icon-done"),this.#s=setTimeout(()=>{t.classList.remove("icon-done")},1e3)}finally{t.disabled=!1}}),r?.addEventListener("click",async()=>{try{r.disabled=!0,this.#o??=this.#a();let n=await this.#o;if(!n)return;await navigator.share({files:[new File([n],this.#e?.fileName??"",{type:n.type})]}),this.#d&&clearTimeout(this.#d),r.classList.add("icon-done"),this.#d=setTimeout(()=>{r.classList.remove("icon-done")},1e3)}finally{r.disabled=!1}}),"share"in navigator||r?.remove()}async#a(o=!1){if(o)return this.#e?.provideClipboard?this.#e.provideClipboard():(this.#o??=this.#a(),this.#o);if(!this.#e)return null;if(this.#e.value instanceof Blob)return this.#e.value;if(this.#e.value instanceof CanvasRenderingContext2D){let{canvas:r}=this.#e.value;return new Promise((n,l)=>{r.toBlob(s=>{if(!s){l(new Error("canvas.toBlob returned null"));return}this.#e&&this.#c(s),n(s)})})}if(!this.#e.provideDownload)return null;let t=await this.#e.provideDownload();return this.#c(t),t}#c(o){let t=this.#n?this.#r?.fileName:this.#l.fileName;if(this.#e&&t){let r=this.#e.fileName??"";o&&(r&&(r+=" \xB7 "),r+=m(o.size)),t.textContent=r}}handleOutput(o){this.#e=o instanceof File?f.from(o.name,o):o,this.#o=null,this.#i=null,this.#t&&URL.revokeObjectURL(this.#t),this.#t=null;let{copyButton:t,shareButton:r,downloadLink:n}=this.#l;t&&(t.disabled=!1),r&&(r.disabled=!1),n&&(n.download=this.#e.fileName??"",this.#e.value instanceof Blob?(this.#t=URL.createObjectURL(this.#e.value),n.href=this.#t,this.#n&&(this.#r?.button.replaceWith(n),this.#n=!1)):(this.#r??=U(n,async l=>{try{if(l.disabled=!0,!this.#t){this.#o??=this.#a();let s=await this.#o;if(!s)return;this.#t=URL.createObjectURL(s),n.href=this.#t}document.body.append(n),n.click(),n.remove()}finally{l.disabled=!1}}),this.#n||(n.replaceWith(this.#r.button),this.#n=!0))),this.#c(this.#e.value instanceof Blob?this.#e.value:null)}static fromOutputControls(o){let t=o?.querySelector(".download")??null;t&&!(t instanceof HTMLAnchorElement)&&(console.warn(t,"download link is not an <a> element"),t=null);let r=o?.querySelector("button.icon-copy, .reform\\:copy")??null;r&&!(r instanceof HTMLButtonElement)&&(console.warn(r,"copy button is not a <button> element"),r=null);let n=o?.querySelector("button.icon-share")??null;return n&&!(n instanceof HTMLButtonElement)&&(console.warn(n,"copy button is not a <button> element"),n=null),new e({fileName:o?.querySelector(".file-name")??null,downloadLink:t,copyButton:r,shareButton:n})}};function U(e,o){let t=document.createElement("button");t.className=e.className;for(let r of e.childNodes)t.append(r.cloneNode(!0));return t.addEventListener("click",()=>o(t)),{button:t,fileName:t.querySelector(".file-name")}}var f=class{fileName;value;static from(o,t,r="text/plain"){return new B(o,t instanceof Blob||t instanceof CanvasRenderingContext2D?t:new Blob([t],{type:r}))}},B=class extends f{constructor(o,t){super(),this.fileName=o,this.value=t}};var h=class{lastValue;dependents=[];handleValue(o){this.lastValue=o;for(let t of this.dependents)t(o)}};var d={};function H(e){if(!(e instanceof HTMLElement&&e.dataset.ignore))if(e instanceof HTMLInputElement)if(d[e.name]??=new h,e.type==="number"||e.type==="range"||e.inputMode==="numeric"){if(e.value==="")return;d[e.name].handleValue(+e.value);let o=e.closest(".range-wrapper");if(o){let t=e;if(e.type==="range"){let n=o.lastElementChild;n instanceof HTMLInputElement&&(n.value=e.step==="any"||e.step&&+e.step<.1?(+e.value).toFixed(2):e.value)}else{let n=o.querySelector('[type="range"]');if(n instanceof HTMLInputElement)t=n;else return;t.value=e.value}let r=(+e.value-+t.min)/(+t.max-+t.min);t.style.setProperty("--progress",`${r*100}%`)}}else e.type==="checkbox"?d[e.name].handleValue(e.checked):e.type==="file"?e.files&&e.files.length>0&&d[e.name].handleValue(Array.from(e.files)):e.type==="radio"?e.checked&&d[e.name].handleValue(e.value):d[e.name].handleValue(e.value);else(e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(d[e.name]??=new h,d[e.name].handleValue(e.value))}for(let e of document.getElementsByClassName("reform:image-input"))e instanceof HTMLInputElement&&(d[e.name]??=new h,F(d[e.name],e));for(let e of document.getElementsByClassName("reform:video-input"))e instanceof HTMLInputElement&&(d[e.name]??=new h,R(d[e.name],e));for(let e of document.getElementsByClassName("reform:text-input"))e instanceof HTMLInputElement&&(d[e.name]??=new h,N(d[e.name],e));for(let e of document.getElementsByClassName("reform:file-input"))e instanceof HTMLInputElement&&(d[e.name]??=new h,O(d[e.name],e));for(let e of document.forms)for(let o of e.elements)H(o);document.addEventListener("input",e=>H(e.target));document.addEventListener("change",e=>H(e.target));var M={};function P(e){let o=typeof e=="string"?e:e.name;if(!M[o]){let t=document.getElementById(o);if(!t){let l=document.getElementsByName(o);l.length>1&&console.warn("More than one element with name",o,Array.from(l)),t=l[0]??null}let r=t instanceof HTMLCanvasElement?t.getContext("2d"):t,n=typeof e!="string"&&e.deps||t?.dataset.deps?.split(" ")||[];M[o]={name:o,element:t,object:r,deps:n.map(l=>l.startsWith("&")?{name:l.slice(1),reference:!0}:{name:l,reference:!1})}}return M[o]}function ee(e,o){let{name:t,element:r,object:n,deps:l}=P(e);d[t]??=new h;let s={callback:i=>{d[t].handleValue(i)}},p=r?.closest(".reform\\:io")?.querySelector(".output-controls");if(p){let i=E.fromOutputControls(p);d[t].dependents.push(c=>{(c instanceof File||c instanceof f)&&i.handleOutput(c)})}let g=0,u=async()=>{if(a.size===l.length){let i=++g,c=await o(n,s);if(i!==g)return;c!==void 0&&d[t].handleValue(c)}},a=new Set;for(let{name:i,reference:c}of l)if(c){let{object:b}=P(i);s[i]=b,a.add(i)}else d[i]??=new h,d[i].lastValue!==void 0&&(s[i]=d[i].lastValue,a.add(i)),d[i].dependents.push(b=>{s[i]=b,a.add(i),u()});u()}export{f as OutputProvider,ee as on};
//# sourceMappingURL=index.js.map
