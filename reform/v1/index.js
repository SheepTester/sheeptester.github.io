var k=0,f,x;function H(e){if(!x||!f){f=Object.assign(document.createElement("a"),{className:"error-count",href:"#errors"});let t=Object.assign(document.createElement("h2"),{className:"error-count-wrapper"});t.append(f);let r=Object.assign(document.createElement("p"),{className:"error-note",textContent:"It could be due to a bug, or your input is not the correct format. If you'd like to report the error, please send me the entire error log below."});x=Object.assign(document.createElement("pre"),{className:"error-log"});let l=Object.assign(document.createElement("div"),{className:"error-wrapper",id:"errors"});l.append(r,x),document.body.append(t,l)}x.append(e,`
`),k++,f.textContent=`${k} error${k===1?"":"s"} occurred`}window.onerror=(e,t,r,l,n)=>{H(n?.stack?`Uncaught ${n.stack}`:`Uncaught ${n?.name??String(n)}: ${e} at ${t}:${r}${l!==void 0?":"+l:""}`)};window.addEventListener("unhandledrejection",e=>{H(e.reason?.stack?`Uncaught (in promise) ${e.reason.stack}`:e.reason instanceof Error?`Uncaught (in promise) ${e.reason.constructor.name}: ${e.reason.message}`:String(e.reason))});function m(e){return e>1e9?`${(e/1e9).toPrecision(3)} GB`:e>1e6?`${(e/1e6).toPrecision(3)} MB`:e>1e3?`${(e/1e3).toPrecision(3)} kB`:e!==1?`${e} bytes`:"1 byte"}function E(e){let t=e.lastIndexOf(".");return t===-1?e:e.slice(0,t)}var O=new TextEncoder;function C(e,t){return e.find(({type:r})=>t.some(l=>r.startsWith(l)))??e[0]}function V(e){return e.kind==="string"?new Promise(t=>e.getAsString(t)):Promise.resolve(e.getAsFile())}function v({fileName:e,input:t,dropTarget:r,pasteTarget:l,pasteButton:n,defaultPreferredTypes:i,onFile:p}){let c=t.accept?t.accept.replaceAll("*","").split(","):i;async function u(o){let d;switch(o.type){case"files":{d=C(Array.from(o.files),c);break}case"data-transfer":{d=await V(C(Array.from(o.transfer.items),c));break}case"clipboard":{console.log(o,c);let{item:g,type:b}=C(o.items,c),M=await g.getType(b);d=new File([M],b.replaceAll("/","_"),{type:M.type});break}}if(d===null)return;let a=d instanceof File?`${d.name} \xB7 ${m(d.size)}`:`Plain text \xB7 ${m(O.encode(d).length)}`;try{(await p(d)??!0)&&e&&(e.textContent=a,e.classList.remove("file-error"))}catch(g){throw e&&(e.textContent=a+" \u2014 failed to load",e.classList.add("file-error")),g}}if(t.addEventListener("change",()=>{t.files&&t.files.length>0&&u({type:"files",files:t.files}),t.value=""}),t.dataset.default){let o=t.dataset.default,d=o.slice(o.lastIndexOf("/")+1);fetch(o).then(a=>a.blob()).catch(a=>{throw e&&(e.textContent=d+" \u2014 failed to load",e.classList.add("file-error")),a}).then(a=>u({type:"files",files:[new File([a],d,a)]}))}r?.addEventListener("drop",o=>{o.dataTransfer&&o.dataTransfer.items.length>0&&u({type:"data-transfer",transfer:o.dataTransfer}),r.classList.remove("drag-over"),o.preventDefault()}),r?.addEventListener("dragover",o=>{r.classList.add("drag-over"),o.preventDefault()}),r?.addEventListener("dragleave",()=>{r.classList.remove("drag-over")}),l&&document.addEventListener("paste",o=>{(o.target instanceof HTMLTextAreaElement||o.target instanceof HTMLInputElement)&&!o.target.readOnly&&!o.target.disabled||o.clipboardData&&o.clipboardData.items.length>0&&u({type:"data-transfer",transfer:o.clipboardData})}),n?.addEventListener("click",()=>{navigator.clipboard.read().then(o=>{let d=o.flatMap(a=>a.types.map(g=>({item:a,type:g})));d.length>0&&u({type:"clipboard",items:d})}).catch(o=>{if(o instanceof DOMException&&o.name==="NotAllowedError")console.warn("Failed to read clipboard",o);else throw o})})}function I(e,t){t.dataset.ignore="true";let r=t.closest(".reform\\:io"),l=w(r);v({fileName:t.parentElement?.querySelector(".file-name")??null,input:t,dropTarget:r instanceof HTMLElement?r:null,pasteTarget:t.classList.contains("reform:paste-target"),pasteButton:l,defaultPreferredTypes:[],onFile:async n=>{e.handleValue(n instanceof File?n:new File([n],"text.txt",{type:"text/plain"}))}})}function B(e,t){t.dataset.ignore="true";let r=t.closest(".reform\\:io"),l=w(r),n=r?.querySelector(".input-content canvas");n&&!(n instanceof HTMLCanvasElement)&&(console.warn(n,"is not a <canvas> element"),n=null);let i=n??document.createElement("canvas"),p=i.getContext("2d",{willReadFrequently:!!i.dataset.willReadFrequently});if(!p)throw new TypeError("Failed to get canvas context for the image input preview.");v({fileName:t.parentElement?.querySelector(".file-name")??null,input:t,dropTarget:r instanceof HTMLElement?r:null,pasteTarget:t.classList.contains("reform:paste-target")??!1,pasteButton:l,defaultPreferredTypes:["image/*"],onFile:async c=>{if(typeof c=="string")return!1;let u=URL.createObjectURL(c);try{let o=document.createElement("img");o.src=u,await new Promise((d,a)=>{o.addEventListener("load",d),o.addEventListener("error",()=>a(new TypeError(`Could not load '${c.name}' as image.`)))}),i.dataset.name=E(c.name),i.width=o.width,i.height=o.height,p.drawImage(o,0,0),e.handleValue(p)}finally{URL.revokeObjectURL(u)}}})}function j(e,t){let r=t.closest(".reform\\:io"),l=w(r),n=r?.querySelector(".input-content video");n&&!(n instanceof HTMLVideoElement)&&(console.warn(n,"is not a <video> element"),n=null);let i=n??document.createElement("video"),p;v({fileName:t.parentElement?.querySelector(".file-name")??null,input:t,dropTarget:r instanceof HTMLElement?r:null,pasteTarget:t.classList.contains("reform:paste-target"),pasteButton:l,defaultPreferredTypes:["video/*"],onFile:async c=>{if(typeof c=="string")return!1;p&&URL.revokeObjectURL(p),p=URL.createObjectURL(c),i.src=p,i.dataset.name=E(c.name),await new Promise((u,o)=>{i.onloadeddata=()=>{i.readyState<2||u()},i.onerror=()=>o(new TypeError(`Could not load '${c.name}' as video.`))}),e.handleValue(i)}})}function S(e,t){let r=t.closest(".reform\\:io"),l=w(r);t.dataset.ignore="true";let n=r?.querySelector(".input-controls"),i=r?.querySelector(".input-content");v({fileName:t.parentElement?.querySelector(".file-name")??null,input:t,dropTarget:n instanceof HTMLElement?n:null,pasteTarget:t.classList.contains("reform:paste-target"),pasteButton:l,defaultPreferredTypes:["text/plain"],onFile:async p=>{let c=p instanceof File?await p.text():p;i instanceof HTMLTextAreaElement&&(i.value=c),e.handleValue(c)}})}function w(e){let t=e?.querySelector(".input-controls");if(t instanceof HTMLLabelElement){let r=document.createElement("div");r.classList.add("input-controls"),t.classList.remove("input-controls"),t.replaceWith(r),r.append(t),t=r}if(t&&!e?.querySelector(".reform\\:paste")){let r=document.createElement("button");return r.type="button",r.classList.add("icon","icon-paste","reform:paste"),r.ariaLabel="Paste from clipboard",t.append(r),r}return null}var y=class e{#e=null;#t=null;#o;#r;constructor({fileName:t=null,downloadLink:r=null,copyButton:l,shareButton:n}){this.#o=t,this.#r=r,l?.addEventListener("click",()=>{this.#e&&navigator.clipboard.write([new ClipboardItem({[this.#e.type]:this.#e})])}),n?.addEventListener("click",async()=>{this.#e&&(this.#e.type==="text/plain"&&this.#e.size<4e3?navigator.share({text:await this.#e.text()}):navigator.share({files:[this.#e]}))}),"share"in navigator||n?.remove()}handleFile(t){this.#e=t,this.#o&&(this.#o.textContent=`${t.name} \xB7 ${m(t.size)}`),this.#r&&(this.#t&&URL.revokeObjectURL(this.#t),this.#t=URL.createObjectURL(t),this.#r.href=this.#t,this.#r.download=t.name)}static fromOutputControls(t){let r=t?.querySelector(".download");return r&&!(r instanceof HTMLAnchorElement)&&(console.warn(r,"is not an <a> element"),r=null),new e({fileName:t?.querySelector(".file-name"),downloadLink:r,copyButton:t?.querySelector("button.icon-copy, .reform\\:copy"),shareButton:t?.querySelector("button.icon-share")})}};var h=class{lastValue;dependents=[];handleValue(t){this.lastValue=t;for(let r of this.dependents)r(t)}};var s={};function T(e){if(!(e instanceof HTMLElement&&e.dataset.ignore))if(e instanceof HTMLInputElement)if(s[e.name]??=new h,e.type==="number"||e.type==="range"||e.inputMode==="numeric"){if(e.value==="")return;s[e.name].handleValue(+e.value);let t=e.closest(".range-wrapper");if(t){let r=e;if(e.type==="range"){let n=t.lastElementChild;n instanceof HTMLInputElement&&(n.value=e.step==="any"||e.step&&+e.step<.1?(+e.value).toFixed(2):e.value)}else{let n=t.querySelector('[type="range"]');if(n instanceof HTMLInputElement)r=n;else return;r.value=e.value}let l=(+e.value-+r.min)/(+r.max-+r.min);r.style.setProperty("--progress",`${l*100}%`)}}else e.type==="checkbox"?s[e.name].handleValue(e.checked):e.type==="file"?e.files&&e.files.length>0&&s[e.name].handleValue(Array.from(e.files)):e.type==="radio"?e.checked&&s[e.name].handleValue(e.value):s[e.name].handleValue(e.value);else(e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(s[e.name]??=new h,s[e.name].handleValue(e.value))}for(let e of document.getElementsByClassName("reform:image-input"))e instanceof HTMLInputElement&&(s[e.name]??=new h,B(s[e.name],e));for(let e of document.getElementsByClassName("reform:video-input"))e instanceof HTMLInputElement&&(s[e.name]??=new h,j(s[e.name],e));for(let e of document.getElementsByClassName("reform:text-input"))e instanceof HTMLInputElement&&(s[e.name]??=new h,S(s[e.name],e));for(let e of document.getElementsByClassName("reform:file-input"))e instanceof HTMLInputElement&&(s[e.name]??=new h,I(s[e.name],e));for(let e of document.forms)for(let t of e.elements)T(t);document.addEventListener("input",e=>T(e.target));document.addEventListener("change",e=>T(e.target));var L={};function F(e){let t=typeof e=="string"?e:e.name;if(!L[t]){let r=document.getElementById(t);if(!r){let i=document.getElementsByName(t);i.length>1&&console.warn("More than one element with name",t,Array.from(i)),r=i[0]??null}let l=r instanceof HTMLCanvasElement?r.getContext("2d"):r,n=typeof e!="string"&&e.deps||r?.dataset.deps?.split(" ")||[];L[t]={name:t,element:r,object:l,deps:n.map(i=>i.startsWith("&")?{name:i.slice(1),reference:!0}:{name:i,reference:!1})}}return L[t]}function K(e,t){let{name:r,element:l,object:n,deps:i}=F(e);s[r]??=new h;let p={callback:a=>{s[r].handleValue(a)}},c=l?.closest(".reform\\:io")?.querySelector(".output-controls");if(c){let a=y.fromOutputControls(c);s[r].dependents.push(g=>g instanceof File&&a.handleFile(g))}let u=0,o=async()=>{if(d.size===i.length){let a=++u,g=await t(n,p);if(a!==u)return;g!==void 0&&s[r].handleValue(g)}},d=new Set;for(let{name:a,reference:g}of i)if(g){let{object:b}=F(a);p[a]=b,d.add(a)}else s[a]??=new h,s[a].lastValue!==void 0&&(p[a]=s[a].lastValue,d.add(a)),s[a].dependents.push(b=>{p[a]=b,d.add(a),o()});o()}export{K as on};
//# sourceMappingURL=index.js.map
